"""
Created on Mon Jun  1 22:35:38 2020

@aut
"""
import sys
import argparse
import numpy as np
import h5py
import shutil
import os

parser = argparse.ArgumentParser(description='Turn Seurat output into h5 file that could be re-analyzed by Cellranger.')
parser.add_argument('-m', '--matrix', required=True, help = 'Path to mtx file of Seurat output')
parser.add_argument('-c','--crh5', required=True, help = 'Path of the h5 file generated by Cellranger')
parser.add_argument('-o', '--output', required=True, help = 'H5 file to be handled.')
parser.add_argument('--cellranger_path', default = '/home/zyserver/shizhuoxing/software/cellranger-3.1.0/', help = 'Main path of Cellrager.')
args = parser.parse_args()


sys.path.append(args.cellranger_path+"/cellranger-cs/3.1.0/tenkit/lib/python/")
sys.path.append(args.cellranger_path+"/cellranger-cs/3.1.0/lib/python/")
import cellranger.matrix as cr_matrix

mtx = cr_matrix.CountMatrix.load_mtx(args.matrix)
mtx.save_h5_file(args.output)

CR_H5 = args.matrix + '/' + 'tmp.h5'
shutil.copyfile(args.crh5,CR_H5) 

with h5py.File(args.output,'r') as seu, h5py.File(CR_H5,'a') as cel:
	del cel['matrix/barcodes']
	cel.create_dataset('matrix/barcodes', data=seu['matrix/barcodes'])
	del cel['matrix/data']
	cel.create_dataset('matrix/data', data=seu['matrix/data'])
	del cel['matrix/indices']
	cel.create_dataset('matrix/indices', data=seu['matrix/indices'])
	del cel['matrix/indptr']
	cel.create_dataset('matrix/indptr', data=seu['matrix/indptr'])
	del cel['matrix/shape']
	cel.create_dataset('matrix/shape', data=seu['matrix/shape'])

	ftshape = seu['matrix/features/feature_type'].shape[0]
	genome_new = np.repeat(cel['matrix/features/genome'][0],ftshape)

	del cel['matrix/features/genome']
	cel.create_dataset('matrix/features/genome', data=genome_new)
	del cel['matrix/features/feature_type']
	cel.create_dataset('matrix/features/feature_type', data=seu['matrix/features/feature_type'])
	del cel['matrix/features/id']
	cel.create_dataset('matrix/features/id', data=seu['matrix/features/id'])
	del cel['matrix/features/name']
	cel.create_dataset('matrix/features/name', data=seu['matrix/features/name'])

os.remove(args.output)
shutil.copyfile(CR_H5,args.output)
os.remove(CR_H5)
